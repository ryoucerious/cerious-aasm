<div class="card">
  <div class="card-header button-header collapsible-header" (click)="onToggleVisibility()">
    <h2>SERVER SETTINGS</h2>
    <div class="button-header-actions">
      <input type="file" #configFileInput hidden accept=".ini" (change)="onFileSelected($event)">
      <button class="btn" (click)="onImportConfig($event)" title="Import settings from an INI file">
        <i class="material-icons">file_upload</i> Import
      </button>
      <button class="btn" (click)="onExportConfig($event)" title="Export server configuration as ZIP">
        <i class="material-icons">file_download</i> Export
      </button>
      <button class="btn" (click)="onOpenCopyConfig($event)" title="Copy settings from another server">
        <i class="material-icons">content_copy</i> Copy From
      </button>
      <button *ngIf="isElectron" class="btn" (click)="onOpenDirectory($event)">
        <i class="material-icons">folder_open</i> Open Directory
      </button>
      <span class="material-icons">
        {{ isVisible ? 'expand_more' : 'expand_less' }}
      </span>
    </div>
  </div>
  <div class="card-body" *ngIf="isVisible">
    <div class="tabs">
      <button class="tab" [class.active]="activeTab === 'general'" (click)="onTabChange('general')">
        <i class="material-icons">tune</i> General
      </button>
      <button class="tab" [class.active]="activeTab === 'rates'" (click)="onTabChange('rates')">
        <i class="material-icons">speed</i> Rates
      </button>
      <button class="tab" [class.active]="activeTab === 'structures'" (click)="onTabChange('structures')">
        <i class="material-icons">home</i> Structures
      </button>
      <button class="tab" [class.active]="activeTab === 'stats'" (click)="onTabChange('stats')">
        <i class="material-icons">bar_chart</i> Stat Multipliers
      </button>
      <button class="tab" [class.active]="activeTab === 'misc'" (click)="onTabChange('misc')">
        <i class="material-icons">settings</i> Miscellaneous
      </button>
      <button class="tab" [class.active]="activeTab === 'cluster'" (click)="onTabChange('cluster')">
        <i class="material-icons">group_work</i> Cluster
      </button>
      <button class="tab" [class.active]="activeTab === 'mods'" (click)="onTabChange('mods')">
        <i class="material-icons">extension</i> Mods
      </button>
      <button class="tab" [class.active]="activeTab === 'whitelist'" (click)="onTabChange('whitelist')">
        <i class="material-icons">people</i> Whitelist
      </button>
      <button class="tab" [class.active]="activeTab === 'automation'" (click)="onTabChange('automation')">
        <i class="material-icons">schedule</i> Automation
      </button>
      <button class="tab" [class.active]="activeTab === 'discord'" (click)="onTabChange('discord')">
        <i class="material-icons">chat</i> Discord
      </button>
      <button class="tab" [class.active]="activeTab === 'broadcasts'" (click)="onTabChange('broadcasts')">
        <i class="material-icons">campaign</i> Broadcasts
      </button>
      <!-- <button class="tab" [class.active]="activeTab === 'players'" (click)="onTabChange('players')">
        <i class="material-icons">people_outline</i> Players
      </button> -->
      <button class="tab" [class.active]="activeTab === 'firewall'" (click)="onTabChange('firewall')"
              *ngIf="isLinux">
        <i class="material-icons">security</i> Firewall
      </button>
      <button class="tab" [class.active]="activeTab === 'backup'" (click)="onBackupTabClick()">
        <i class="material-icons">backup</i> Backup
      </button>
    </div>
    
    <!-- General Tab Content -->
    <app-general-tab
      *ngIf="activeTab === 'general'"
      [serverInstance]="serverInstance"
      [isLocked]="isLocked"
      [generalFields]="generalFields"
      [dropdownOpen]="dropdownOpen"
      (saveSettings)="onSaveSettings()"
      (validateField)="validateField($event.key, $event.value)"
      (toggleMultiOption)="onToggleMultiOption($event.key, $event.option, $event.checked)"
      (mapSelect)="onMapSelect($event.value, $event.key)"
      (mapInput)="onMapInput($event.event, $event.key)"
      (dropdownToggle)="dropdownOpen = $event">
    </app-general-tab>    <!-- Rates Tab Content -->
    <app-rates-tab
      *ngIf="activeTab === 'rates'"
      [serverInstance]="serverInstance"
      [isLocked]="isLocked"
      [ratesFields]="ratesFields"
      (saveSettings)="onSaveSettings()"
      (validateField)="validateField($event.key, $event.value)">
    </app-rates-tab>
    
    <!-- Structures Tab Content -->
    <app-structures-tab
      *ngIf="activeTab === 'structures'"
      [serverInstance]="serverInstance"
      [isLocked]="isLocked"
      [structuresFields]="structuresFields"
      (saveSettings)="onSaveSettings()"
      (validateField)="validateField($event.key, $event.value)">
    </app-structures-tab>
    
    <!-- Stats Tab Content -->
    <app-stat-multipliers-tab
      *ngIf="activeTab === 'stats'"
      [serverInstance]="serverInstance"
      [isLocked]="isLocked"
      [statList]="statList"
      [selectedStatIndex]="selectedStatIndex"
      [statSelectorDropdownOpen]="statSelectorDropdownOpen"
      (statMultiplierChanged)="onStatMultiplierChange($event.type, $event.statIndex, $event.value)"
      (resetStatToDefaults)="onResetStatToDefaults($event)"
      (copyStatToAll)="onCopyStatToAll($event)"
      (toggleStatSelectorDropdown)="toggleStatSelectorDropdown()"
      (statSelectorSelect)="onStatSelectorSelect($event)">
    </app-stat-multipliers-tab>
    
    <!-- Misc Tab Content -->
    <app-misc-tab
      *ngIf="activeTab === 'misc'"
      [serverInstance]="serverInstance"
      [isLocked]="isLocked"
      [miscFields]="miscFields"
      (saveSettings)="onSaveSettings()"
      (validateField)="validateField($event.key, $event.value)">
    </app-misc-tab>

    <!-- Cluster Tab Content -->
    <app-cluster-tab
      *ngIf="activeTab === 'cluster'"
      [serverInstance]="serverInstance"
      [isLocked]="isLocked"
      (saveSettings)="onSaveSettings()"
      (validateField)="validateField($event.key, $event.value)">
    </app-cluster-tab>
    
    <!-- Mods Tab Content -->
    <app-mods-tab
      *ngIf="activeTab === 'mods'"
      [isLocked]="isLocked"
      [modList]="modList"
      (addMod)="addMod.emit($event)"
      (removeMod)="removeMod.emit($event)"
      (toggleMod)="toggleMod.emit($event)"
      (updateModSettings)="updateModSettings.emit($event)">
    </app-mods-tab>
    
    <!-- Whitelist Tab Content -->
    <app-whitelist-tab
      *ngIf="activeTab === 'whitelist'"
      [serverInstance]="serverInstance"
      [isLocked]="isLocked"
      (saveSettings)="onSaveSettings()"
      (validateField)="validateField($event.key, $event.value)"
      (statusUpdate)="onWhitelistStatusUpdate($event)">
    </app-whitelist-tab>
    
    <!-- Backup Tab Content -->
    <app-backup-tab
      *ngIf="activeTab === 'backup'"
      [backupScheduleEnabled]="backupScheduleEnabled"
      [backupFrequency]="backupFrequency"
      [backupTime]="backupTime"
      [backupDayOfWeek]="backupDayOfWeek"
      [maxBackupsToKeep]="maxBackupsToKeep"
      [backupList]="backupList"
      [isBackupLocked]="isBackupLocked"
      [backupFrequencyDropdownOpen]="backupFrequencyDropdownOpen"
      [backupDayDropdownOpen]="backupDayDropdownOpen"
      (createManualBackup)="onCreateManualBackup()"
      (backupScheduleToggle)="onBackupScheduleToggle()"
      (backupFrequencySelect)="onBackupFrequencySelect($event)"
      (backupTimeChange)="onBackupTimeChange($event)"
      (backupDaySelect)="onBackupDaySelect($event)"
      (maxBackupsToKeepChange)="onMaxBackupsToKeepChange($event)"
      (restoreBackup)="onRestoreBackup($event)"
      (downloadBackup)="onDownloadBackup($event)"
      (deleteBackup)="onDeleteBackup($event)"
      (validateField)="validateField($event.key, $event.value)"
      (toggleBackupFrequencyDropdown)="toggleBackupFrequencyDropdown()"
      (toggleBackupDayDropdown)="toggleBackupDayDropdown()">
    </app-backup-tab>

    <!-- Automation Tab Content -->
    <app-automation-tab
      *ngIf="activeTab === 'automation'"
      [serverInstance]="serverInstance"
      [restartFrequencyDropdownOpen]="restartFrequencyDropdownOpen"
      (saveAutoStartSettings)="onSaveAutoStartSettings()"
      (saveCrashDetectionSettings)="onSaveCrashDetectionSettings()"
      (saveScheduledRestartSettings)="onSaveScheduledRestartSettings()"
      (validateField)="validateField($event.key, $event.value)"
      (restartDayToggle)="onRestartDayToggle($event.dayIndex, $event.event)"
      (restartFrequencySelect)="onRestartFrequencySelect($event)"
      (toggleRestartFrequencyDropdown)="toggleRestartFrequencyDropdown()">
    </app-automation-tab>

    <!-- Firewall Tab Content -->
    <app-firewall-tab
      *ngIf="activeTab === 'firewall'"
      [serverInstance]="serverInstance">
    </app-firewall-tab>

    <!-- Discord Tab Content -->
    <app-discord-tab
      *ngIf="activeTab === 'discord'"
      [serverInstance]="serverInstance"
      [isLocked]="isLocked"
      (saveSettings)="onSaveSettings()">
    </app-discord-tab>

    <!-- Broadcasts Tab Content -->
    <app-broadcasts-tab
      *ngIf="activeTab === 'broadcasts'"
      [serverInstance]="serverInstance"
      [isLocked]="isLocked"
      (saveSettings)="onSaveSettings()">
    </app-broadcasts-tab>

    <!-- Player List Content -->
    <!-- <div *ngIf="activeTab === 'players'" class="h-[600px]">
        <app-player-list [serverInstance]="serverInstance"></app-player-list>
    </div> -->
  </div>
</div>

<!-- Copy Config Modal -->
<app-modal [title]="'Copy Config From Another Server'" [show]="showCopyConfigModal" [maxWidth]="'840px'" (close)="onCloseCopyConfig()">
  <div class="copy-config-modal">
    <div class="form-group">
      <label>Source Server</label>
      <div class="custom-dropdown" style="position: relative;">
        <button type="button" class="form-control input" (click)="toggleCopyConfigDropdown()" style="width: 100%; text-align: left; background: #23272f; border: 1px solid #444; border-radius: 6px; color: #b0b6c1; padding: 0.5rem 1rem; font-size: 0.97em; display: flex; align-items: center; justify-content: space-between;">
          <span>{{ selectedSourceServer ? getSourceServerDisplayName() : 'Select a server...' }}</span>
          <span class="material-icons" style="font-size: 1.1em;">{{ copyConfigDropdownOpen ? 'arrow_drop_up' : 'arrow_drop_down' }}</span>
        </button>
        <div *ngIf="copyConfigDropdownOpen" class="dropdown-menu show" style="position: absolute; left: 0; right: 0; top: 100%; background: #23272f; border: 1px solid #444; border-radius: 6px; z-index: 20; width: 100%; margin-top: 0.1rem; max-height: 200px; overflow-y: auto;">
          <div *ngFor="let server of allServers" (mousedown)="onSelectSourceServer(server)" style="padding: 0.5rem 1rem; cursor: pointer; color: #b0b6c1; font-size: 0.97em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" [ngClass]="{'selected': selectedSourceServer?.id === server.id}">
            {{ server.sessionName || server.name }} ({{ server.mapName || 'Unknown Map' }})
          </div>
        </div>
      </div>
    </div>

    <div class="form-group" *ngIf="selectedSourceServer">
      <label>Categories to Copy</label>
      <div class="copy-categories-header">
        <button class="btn btn-sm" (click)="toggleAllCategories(true)">Select All</button>
        <button class="btn btn-sm" (click)="toggleAllCategories(false)">Deselect All</button>
      </div>
      <div class="copy-categories-grouped">
        <div *ngFor="let group of configCategoryGroups" class="copy-category-group">
          <div class="copy-category-group-label">{{ group.label }}</div>
          <div class="copy-categories-grid">
            <label *ngFor="let cat of group.categories" class="copy-category-item">
              <div class="toggle-label">
                <input type="checkbox" class="toggle-switch" [(ngModel)]="copyCategories[cat.key]">
                <span class="toggle-text">{{ cat.label }}</span>
              </div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="action-group-modal">
      <button class="btn" (click)="onCloseCopyConfig()">Cancel</button>
      <button class="btn btn-primary" 
              [disabled]="!selectedSourceServer || !hasAnyCategorySelected"
              (click)="onApplyCopyConfig()">
        <i class="material-icons">content_copy</i> Apply
      </button>
    </div>
  </div>
</app-modal>
